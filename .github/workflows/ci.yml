name: ðŸ”„ CI/CD Pipeline

on:
  push:
    branches: [ main, dev, feature/*, fix/* ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  pages: write
  actions: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx2048m -XX:MaxMetaspaceSize=512m"

jobs:
  build-and-test:
    name: ðŸ”¨ Build & Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: [17, 21]
      fail-fast: false

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: â˜• Setup JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java-version }}

      - name: ðŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ˜ Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}

      - name: ðŸ”¨ Build and test project
        run: ./gradlew clean build test

      - name: ðŸ“Š Run quality checks
        run: ./gradlew runAllChecks

      - name: ðŸ“‹ Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-jdk-${{ matrix.java-version }}
          path: |
            shared/build/reports/tests/
            shared/build/reports/ktlint/
            shared/build/reports/detekt/
            shared/build/reports/kover/
          retention-days: 7

  coverage:
    name: ðŸ“Š Test Coverage
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: â˜• Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ˜ Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: ðŸ§ª Generate coverage report
        run: ./gradlew test koverXmlReport

      - name: ðŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./shared/build/reports/kover/report.xml
          fail_ci_if_error: false
          verbose: true

  dependency-scan:
    name: ðŸ” Dependency Scan
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: ðŸ” Security scan summary
        run: |
          echo "ðŸ” Dependency security scanning"
          echo "â„¹ï¸ Automated scanning is handled by GitHub's Dependabot"
          echo "ðŸ“‹ Check the Security tab for vulnerability alerts"
          echo "ðŸ”„ Dependabot will create PRs for updates automatically"
          echo "âœ… Security scanning configured"

  build-summary:
    name: ðŸ“‹ Build Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, coverage, dependency-scan]
    if: always()

    steps:
      - name: ðŸ“Š Generate build summary
        run: |
          echo "## ðŸ”„ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Test | ${{ needs.build-and-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Coverage | ${{ needs.coverage.result == 'success' && 'âœ… Generated' || needs.coverage.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result == 'success' && 'âœ… Completed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“š [Documentation](https://gatrongdev.github.io/kbignum/)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ  [Repository](https://github.com/gatrongdev/kbignum)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ [Maven Central](https://central.sonatype.com/artifact/io.github.gatrongdev/kbignum)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š [Codecov](https://codecov.io/gh/gatrongdev/kbignum)" >> $GITHUB_STEP_SUMMARY