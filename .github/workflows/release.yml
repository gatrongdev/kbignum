name: ğŸš€ Release & Publish

on:
  push:
    branches: [ main ]
    paths:
      - 'shared/build.gradle.kts'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx2048m -XX:MaxMetaspaceSize=512m"

jobs:
  version-check:
    name: ğŸ” Version Check
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_release: ${{ steps.tag_check.outputs.should_release }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Get version from gradle
        id: version
        run: |
          VERSION=$(grep 'version = ' shared/build.gradle.kts | head -1 | sed 's/.*version = "\(.*\)".*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Current version: $VERSION"

      - name: âœ… Check if should release
        id: tag_check
        run: |
          if git tag | grep -q "^v${{ steps.version.outputs.version }}$"; then
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Tag v${{ steps.version.outputs.version }} already exists - skipping release"
          else
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "âœ… Tag v${{ steps.version.outputs.version }} does not exist - will create release"
          fi

  create-release:
    name: ğŸ‰ Create GitHub Release
    runs-on: ubuntu-latest
    needs: version-check
    if: needs.version-check.outputs.should_release == 'true'
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ğŸ˜ Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: ğŸ”¨ Build and test
        run: ./gradlew clean build test

      - name: ğŸ“ Generate changelog
        id: changelog
        run: |
          VERSION="v${{ needs.version-check.outputs.version }}"
          
          # Get the latest tag or use initial commit
          PREVIOUS_TAG=$(git tag --sort=-version:refname | head -1)
          if [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          
          echo "ğŸ“‹ Generating changelog from $PREVIOUS_TAG to HEAD"
          
          # Get commits since last tag
          COMMITS=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD --no-merges)
          
          # Create changelog
          cat << EOF > changelog.md
          ## ğŸš€ What's New in $VERSION

          ### ğŸ“‹ Changes
          $COMMITS

          ### ğŸ“¦ Installation

          #### Gradle (Kotlin DSL)
          \`\`\`kotlin
          dependencies {
              implementation("io.github.gatrongdev:kbignum:${{ needs.version-check.outputs.version }}")
          }
          \`\`\`

          #### Gradle (Groovy)
          \`\`\`gradle
          dependencies {
              implementation 'io.github.gatrongdev:kbignum:${{ needs.version-check.outputs.version }}'
          }
          \`\`\`

          ### ğŸ”— Links
          - ğŸ“š [Documentation](https://gatrongdev.github.io/kbignum/)
          - ğŸ“¦ [Maven Central](https://central.sonatype.com/artifact/io.github.gatrongdev/kbignum)

          **Full Changelog**: https://github.com/gatrongdev/kbignum/compare/$PREVIOUS_TAG...$VERSION
          EOF
          
          CHANGELOG=$(cat changelog.md)
          
          # Save changelog (escape newlines for GitHub Actions)
          {
            echo "changelog<<EOF"
            echo "$CHANGELOG"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: ğŸ‰ Create GitHub Release
        id: release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.version-check.outputs.version }}
          name: KBigNum v${{ needs.version-check.outputs.version }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: ${{ contains(needs.version-check.outputs.version, '-') }}
          files: |
            shared/build/libs/*.jar
            shared/build/outputs/**/*.aar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Release created
        run: |
          echo "release_created=true" >> $GITHUB_OUTPUT
          echo "ğŸ‰ Successfully created release v${{ needs.version-check.outputs.version }}"

  publish-maven:
    name: ğŸ“¦ Publish to Maven Central
    runs-on: macOS-latest
    needs: [version-check, create-release]
    if: needs.version-check.outputs.should_release == 'true' && needs.create-release.outputs.release_created == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21

      - name: ğŸ˜ Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: ğŸ“¦ Publish to Maven Central
        run: ./gradlew publishToMavenCentral --no-configuration-cache
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_KEY_CONTENTS }}

      - name: âœ… Maven publish completed
        run: |
          echo "ğŸ“¦ Successfully published v${{ needs.version-check.outputs.version }} to Maven Central"
          echo "ğŸ”— Check: https://central.sonatype.com/artifact/io.github.gatrongdev/kbignum"

  deploy-docs:
    name: ğŸ“š Deploy Documentation
    runs-on: ubuntu-latest
    needs: [version-check, create-release]
    if: needs.version-check.outputs.should_release == 'true' && needs.create-release.outputs.release_created == 'true'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ğŸ˜ Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: ğŸ“š Generate documentation
        run: ./gradlew dokkaHtml

      - name: ğŸ“¤ Upload documentation artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './shared/build/dokka/html'

      - name: ğŸŒ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: âœ… Documentation deployed
        run: |
          echo "ğŸ“š Documentation deployed successfully"
          echo "ğŸ”— View at: https://gatrongdev.github.io/kbignum/"

  release-summary:
    name: ğŸ“‹ Release Summary
    runs-on: ubuntu-latest
    needs: [version-check, create-release, publish-maven, deploy-docs]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate release summary
        run: |
          echo "## ğŸš€ Release Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version Check | ${{ needs.version-check.result == 'success' && 'âœ… Completed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | ${{ needs.create-release.result == 'success' && 'âœ… Created' || needs.create-release.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Maven Publish | ${{ needs.publish-maven.result == 'success' && 'âœ… Published' || needs.publish-maven.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.deploy-docs.result == 'success' && 'âœ… Deployed' || needs.deploy-docs.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.version-check.outputs.should_release }}" = "true" ]; then
            echo "### ğŸ‰ Release v${{ needs.version-check.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ·ï¸ [GitHub Release](https://github.com/gatrongdev/kbignum/releases/tag/v${{ needs.version-check.outputs.version }})" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“¦ [Maven Central](https://central.sonatype.com/artifact/io.github.gatrongdev/kbignum)" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“š [Documentation](https://gatrongdev.github.io/kbignum/)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â­ï¸ No Release Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Version v${{ needs.version-check.outputs.version }} already exists." >> $GITHUB_STEP_SUMMARY
          fi